import{a as q}from"./chunk-BMJLPOES.js";import{$a as h,Ca as X,Ja as k,Qa as a,Ra as c,Sa as F,Ta as Y,Ua as M,V as d,Va as z,W as l,Wa as u,X as L,Xa as V,Ya as R,Za as B,ab as U,bb as H,c as G,ca as w,fb as A,jb as O,pa as $,qa as m,sb as j}from"./chunk-KJ3BS2IM.js";var J=["svgCanvas"],K=["contentGroup"],Q=class T{svgElement=O.required("svgCanvas");contentGroup=O.required("contentGroup");paths=w([]);currentColor=w("#0c62f0");strokeWidth=w(6);mode=w("draw");scale=w(1);tx=w(0);ty=w(0);MIN_SCALE=.05;MAX_SCALE=20;isDrawing=!1;activePath=null;activePathColor="";activePathWidth=0;isPanning=!1;panPointerId=null;panAnchorWorld=null;pointers=new Map;pinchActive=!1;pinchInitialScale=1;pinchInitialDist=1;pinchAnchorWorld=null;erasePrevScreen=null;transform=A(()=>`translate(${this.tx()},${this.ty()}) scale(${this.scale()})`);status=A(()=>{let t=this.scale(),i=this.tx(),e=this.ty(),n=this.mode();return`scale=${t.toFixed(3)} tx=${i.toFixed(1)} ty=${e.toFixed(1)} | mode=${n}`});cursor=A(()=>this.mode()==="pan"?this.isPanning?"grabbing":"grab":"crosshair");nextId=0;generateId(){return`path-${Date.now()}-${this.nextId++}`}onWindowResize(){}getBoardRect(){return this.svgElement().nativeElement.getBoundingClientRect()}screenToLocalCanvas(t,i){let e=this.getBoardRect();return{x:t-e.left,y:i-e.top}}screenToWorld(t,i){let{x:e,y:n}=this.screenToLocalCanvas(t,i);return{x:(e-this.tx())/this.scale(),y:(n-this.ty())/this.scale()}}dist2D(t,i){return Math.hypot(t.x-i.x,t.y-i.y)}sampleSegmentPoints(t,i,e=8){let n=this.dist2D(t,i),o=Math.max(1,Math.ceil(n/e)),r=[];for(let s=0;s<=o;s++){let p=s/o;r.push({x:t.x+(i.x-t.x)*p,y:t.y+(i.y-t.y)*p})}return r}clampScale(t){return Math.min(this.MAX_SCALE,Math.max(this.MIN_SCALE,t))}onPointerDown(t){if(this.svgElement().nativeElement.setPointerCapture(t.pointerId),this.pointers.set(t.pointerId,{x:t.clientX,y:t.clientY}),this.pointers.size===2&&this.mode()!=="erase"){this.endDraw(),this.isPanning=!1,this.startPinch();return}this.mode()==="draw"?this.startDraw(t):this.mode()==="pan"?this.startPan(t):this.mode()==="erase"&&this.startErase(t)}onPointerMove(t){if(this.pointers.has(t.pointerId)&&this.pointers.set(t.pointerId,{x:t.clientX,y:t.clientY}),this.pinchActive){this.updatePinch();return}this.mode()==="draw"?this.continueDraw(t):this.mode()==="pan"?this.continuePan(t):this.mode()==="erase"&&this.continueErase(t)}onPointerUp(t){let i=this.svgElement().nativeElement;this.pointers.has(t.pointerId)&&this.pointers.delete(t.pointerId),this.pinchActive&&this.pointers.size<2&&this.endPinch(),this.mode()==="draw"?this.endDraw():this.mode()==="pan"?this.endPan(t):this.mode()==="erase"&&this.endErase(),i.releasePointerCapture(t.pointerId)}onPointerCancel(t){let i=this.svgElement().nativeElement;this.pointers.has(t.pointerId)&&this.pointers.delete(t.pointerId),this.pinchActive&&this.pointers.size<2&&this.endPinch(),this.endDraw(),this.endPan(t),this.endErase(),i.releasePointerCapture(t.pointerId)}onWheel(t){t.preventDefault();let i=Math.pow(1.0015,-t.deltaY),e=this.screenToWorld(t.clientX,t.clientY),n=this.screenToLocalCanvas(t.clientX,t.clientY),o=this.clampScale(this.scale()*i);this.tx.set(n.x-o*e.x),this.ty.set(n.y-o*e.y),this.scale.set(o)}startDraw(t){if(this.pointers.size>1)return;this.isDrawing=!0;let{x:i,y:e}=this.screenToWorld(t.clientX,t.clientY);this.activePathColor=this.currentColor(),this.activePathWidth=this.strokeWidth(),this.activePath=document.createElementNS("http://www.w3.org/2000/svg","path"),this.activePath.setAttribute("fill","none"),this.activePath.setAttribute("stroke",this.activePathColor),this.activePath.setAttribute("stroke-width",String(this.activePathWidth)),this.activePath.setAttribute("stroke-linecap","round"),this.activePath.setAttribute("stroke-linejoin","round"),this.activePath.setAttribute("d",`M ${i} ${e}`),this.contentGroup().nativeElement.appendChild(this.activePath)}continueDraw(t){if(!this.isDrawing||!this.activePath)return;let{x:i,y:e}=this.screenToWorld(t.clientX,t.clientY),n=this.activePath.getAttribute("d")+` L ${i} ${e}`;this.activePath.setAttribute("d",n)}endDraw(){if(this.isDrawing&&this.activePath){let t=this.activePath.getAttribute("d")||"",i={id:this.generateId(),d:t,color:this.activePathColor,width:this.activePathWidth};this.activePath.setAttribute("data-id",i.id),this.paths.update(e=>[...e,i])}this.isDrawing=!1,this.activePath=null,this.activePathColor="",this.activePathWidth=0}startPan(t){this.isPanning=!0,this.panPointerId=t.pointerId,this.panAnchorWorld=this.screenToWorld(t.clientX,t.clientY)}continuePan(t){if(!this.isPanning||t.pointerId!==this.panPointerId||!this.panAnchorWorld)return;let i=this.screenToLocalCanvas(t.clientX,t.clientY);this.tx.set(i.x-this.scale()*this.panAnchorWorld.x),this.ty.set(i.y-this.scale()*this.panAnchorWorld.y)}endPan(t){t.pointerId===this.panPointerId&&(this.isPanning=!1,this.panPointerId=null,this.panAnchorWorld=null)}startPinch(){let t=Array.from(this.pointers.keys());if(t.length!==2)return;this.pinchActive=!0;let i=this.pointers.get(t[0]),e=this.pointers.get(t[1]),n={x:(i.x+e.x)/2,y:(i.y+e.y)/2};this.pinchInitialDist=this.dist2D(i,e),this.pinchInitialScale=this.scale(),this.pinchAnchorWorld=this.screenToWorld(n.x,n.y)}updatePinch(){let t=Array.from(this.pointers.keys());if(t.length!==2||!this.pinchActive||!this.pinchAnchorWorld)return;let i=this.pointers.get(t[0]),e=this.pointers.get(t[1]),n=this.dist2D(i,e),o=this.pinchInitialScale*(n/this.pinchInitialDist);o=this.clampScale(o);let r={x:(i.x+e.x)/2,y:(i.y+e.y)/2},s=this.screenToLocalCanvas(r.x,r.y);this.tx.set(s.x-o*this.pinchAnchorWorld.x),this.ty.set(s.y-o*this.pinchAnchorWorld.y),this.scale.set(o)}endPinch(){this.pinchActive=!1,this.pinchAnchorWorld=null}startErase(t){this.erasePrevScreen={x:t.clientX,y:t.clientY},this.eraseAtPoint(t.clientX,t.clientY)}continueErase(t){let i={x:t.clientX,y:t.clientY};if(!this.erasePrevScreen){this.erasePrevScreen=i;return}let e=this.sampleSegmentPoints(this.erasePrevScreen,i,8),n=new Set;for(let o of e){let r=document.elementFromPoint(o.x,o.y);if(!r)continue;let s=r.getAttribute?.("data-id");s&&r.closest?.("#contentGroup")&&n.add(s)}n.size>0&&(this.paths.update(o=>o.filter(r=>!n.has(r.id))),n.forEach(o=>{this.contentGroup().nativeElement.querySelector(`[data-id="${o}"]`)?.remove()})),this.erasePrevScreen=i}eraseAtPoint(t,i){let e=document.elementFromPoint(t,i);if(!e)return;let n=e.getAttribute?.("data-id");n&&e.closest?.("#contentGroup")&&(this.paths.update(o=>o.filter(r=>r.id!==n)),e.remove())}endErase(){this.erasePrevScreen=null}onFileSelected(t){return G(this,null,function*(){let i=t.target,e=i.files?.[0];if(e)try{let n=yield e.text(),r=new DOMParser().parseFromString(n,"image/svg+xml").documentElement,s=this.contentGroup().nativeElement;for(;s.firstChild;)s.removeChild(s.firstChild);this.tx.set(0),this.ty.set(0),this.scale.set(1);let p=C=>{for(let b of Array.from(C.childNodes)){if(b.nodeType!==1)continue;let y=b,f=y.tagName.toLowerCase();if(["style","script","title","desc","defs"].includes(f))continue;if(f==="g"){p(y);continue}let _=document.importNode(y,!0),x=this.generateId();_.setAttribute("data-id",x),f==="path"&&_.setAttribute("fill","none"),s.appendChild(_)}};p(r),this.fitToView()}catch(n){console.error(n),alert("Failed to parse SVG file.")}finally{i.value=""}})}fitToView(){let i=this.contentGroup().nativeElement.querySelectorAll("path");if(i.length===0){this.tx.set(0),this.ty.set(0),this.scale.set(1);return}let e=1/0,n=1/0,o=-1/0,r=-1/0;if(i.forEach(N=>{let g=(N.getAttribute("d")||"").match(/[\d.-]+/g);if(g)for(let P=0;P<g.length;P+=2){let E=parseFloat(g[P]),I=parseFloat(g[P+1]);!isNaN(E)&&!isNaN(I)&&(e=Math.min(e,E),n=Math.min(n,I),o=Math.max(o,E),r=Math.max(r,I))}}),!isFinite(e)){this.tx.set(0),this.ty.set(0),this.scale.set(1);return}let s=50,p=o-e+s*2,C=r-n+s*2,b=this.getBoardRect(),y=b.width,f=b.height,_=y/p,x=f/C,v=Math.min(_,x,1),D=(e+o)/2,S=(n+r)/2;this.scale.set(v),this.tx.set(y/2-D*v),this.ty.set(f/2-S*v)}saveSVG(){let i=this.contentGroup().nativeElement.querySelectorAll("path");if(i.length===0){alert("Nothing to save");return}let e=1/0,n=1/0,o=-1/0,r=-1/0;i.forEach(S=>{let W=(S.getAttribute("d")||"").match(/[\d.-]+/g);if(W)for(let g=0;g<W.length;g+=2){let P=parseFloat(W[g]),E=parseFloat(W[g+1]);!isNaN(P)&&!isNaN(E)&&(e=Math.min(e,P),n=Math.min(n,E),o=Math.max(o,P),r=Math.max(r,E))}});let s=20;e-=s,n-=s,o+=s,r+=s;let p=o-e,C=r-n,b=Array.from(i).map(S=>new XMLSerializer().serializeToString(S)).join(`
`),f=`<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="${e} ${n} ${p} ${C}" preserveAspectRatio="xMidYMid meet">

  <style>
    html, body { height: 100%; margin: 0; background: #fff; }
    svg { width: 100vw; height: 100vh; display: block; background: #fff; }
    path { fill: none; stroke-linecap: round; stroke-linejoin: round; }
  </style>
<rect x="${e}" y="${n}" width="${p}" height="${C}" fill="white"/>
${b}
</svg>`,_=new Blob([f],{type:"image/svg+xml"}),x=URL.createObjectURL(_),v=document.createElement("a"),D=new Date().toISOString().replace(/[:.]/g,"-");v.download=`whiteboard-${D}.svg`,v.href=x,document.body.appendChild(v),v.click(),v.remove(),URL.revokeObjectURL(x)}setMode(t){this.mode.set(t)}clearCanvas(){this.paths.set([]);let t=this.contentGroup().nativeElement;for(;t.firstChild;)t.removeChild(t.firstChild);this.tx.set(0),this.ty.set(0),this.scale.set(1)}static \u0275fac=function(i){return new(i||T)};static \u0275cmp=X({type:T,selectors:[["app-whiteboard3"]],viewQuery:function(i,e){i&1&&(V(e.svgElement,J,5),V(e.contentGroup,K,5)),i&2&&R(2)},hostBindings:function(i,e){i&1&&z("resize",function(){return e.onWindowResize()},$)},decls:39,vars:11,consts:[["fileInput",""],["svgCanvas",""],["contentGroup",""],[1,"whiteboard-container"],[1,"toolbar"],[1,"toolbar-section"],["for","openFile",1,"file-btn"],["id","openFile","type","file","accept",".svg,image/svg+xml","hidden","",3,"change"],["title","Save as SVG",1,"action-btn",3,"click"],[1,"input-label"],["type","color",1,"color-picker",3,"input","value"],["type","range","min","1","max","40",1,"width-slider",3,"input","value"],[1,"width-value"],[1,"toolbar-section","mode-group"],[1,"mode-radio"],["type","radio","name","mode","value","draw",3,"change","checked"],["type","radio","name","mode","value","pan",3,"change","checked"],["type","radio","name","mode","value","erase",3,"change","checked"],["title","Clear canvas",1,"action-btn","danger",3,"click"],[1,"status"],[1,"board-wrapper"],[1,"svg-canvas",3,"pointerdown","pointermove","pointerup","pointercancel","pointerleave","wheel"],["x","0","y","0","width","100%","height","100%","fill","white",1,"hit-area"],["id","contentGroup"]],template:function(i,e){if(i&1){let n=Y();a(0,"div",3)(1,"div",4)(2,"div",5)(3,"label",6),h(4,"Open SVG"),c(),a(5,"input",7,0),u("change",function(r){return d(n),l(e.onFileSelected(r))}),c(),a(7,"button",8),u("click",function(){return d(n),l(e.saveSVG())}),h(8,"Save SVG"),c()(),a(9,"div",5)(10,"label",9),h(11," Color: "),a(12,"input",10),u("input",function(r){return d(n),l(e.currentColor.set(r.target.value))}),c()(),a(13,"label",9),h(14," Width: "),a(15,"input",11),u("input",function(r){return d(n),l(e.strokeWidth.set(+r.target.value))}),c(),a(16,"span",12),h(17),c()()(),a(18,"div",13)(19,"label",14)(20,"input",15),u("change",function(){return d(n),l(e.setMode("draw"))}),c(),h(21," Draw "),c(),a(22,"label",14)(23,"input",16),u("change",function(){return d(n),l(e.setMode("pan"))}),c(),h(24," Pan "),c(),a(25,"label",14)(26,"input",17),u("change",function(){return d(n),l(e.setMode("erase"))}),c(),h(27," Erase "),c()(),a(28,"div",5)(29,"button",18),u("click",function(){return d(n),l(e.clearCanvas())}),h(30,"Clear"),c()(),a(31,"span",19),h(32),c()(),a(33,"div",20),L(),a(34,"svg",21,1),u("pointerdown",function(r){return d(n),l(e.onPointerDown(r))})("pointermove",function(r){return d(n),l(e.onPointerMove(r))})("pointerup",function(r){return d(n),l(e.onPointerUp(r))})("pointercancel",function(r){return d(n),l(e.onPointerCancel(r))})("pointerleave",function(r){return d(n),l(e.onPointerUp(r))})("wheel",function(r){return d(n),l(e.onWheel(r))}),F(36,"rect",22)(37,"g",23,2),c()()()}i&2&&(k("data-mode",e.mode()),m(12),M("value",e.currentColor()),m(3),M("value",e.strokeWidth()),m(2),H("",e.strokeWidth(),"px"),m(3),M("checked",e.mode()==="draw"),m(3),M("checked",e.mode()==="pan"),m(3),M("checked",e.mode()==="erase"),m(6),U(e.status()),m(2),B("cursor",e.cursor()),m(3),k("transform",e.transform()))},dependencies:[j,q],styles:["[_nghost-%COMP%]{display:block;width:100%;height:100vh;overflow:hidden}.whiteboard-container[_ngcontent-%COMP%]{display:grid;grid-template-rows:auto 1fr;width:100%;height:100vh;background:#f7f7f7;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica Neue,Arial,sans-serif}.toolbar[_ngcontent-%COMP%]{display:flex;gap:12px;align-items:center;padding:10px 12px;background:#fff;border-bottom:1px solid #ddd;position:sticky;top:0;z-index:10;-webkit-user-select:none;user-select:none;flex-wrap:wrap}@media (max-width: 640px){.toolbar[_ngcontent-%COMP%]{gap:8px}}.toolbar-section[_ngcontent-%COMP%]{display:flex;align-items:center;gap:12px}@media (max-width: 640px){.toolbar-section[_ngcontent-%COMP%]{gap:8px}}.mode-group[_ngcontent-%COMP%]{display:inline-flex;gap:12px;align-items:center}.mode-radio[_ngcontent-%COMP%]{display:inline-flex;align-items:center;gap:4px;font-size:14px;cursor:pointer}.input-label[_ngcontent-%COMP%]{display:flex;align-items:center;gap:6px;font-size:14px}.width-value[_ngcontent-%COMP%]{min-width:32px}.color-picker[_ngcontent-%COMP%]{width:40px;height:28px;border:1px solid #aaa;border-radius:4px;cursor:pointer;padding:0}.width-slider[_ngcontent-%COMP%]{width:80px;cursor:pointer}.file-btn[_ngcontent-%COMP%], .action-btn[_ngcontent-%COMP%]{padding:6px 10px;border:1px solid #aaa;border-radius:6px;background:#fafafa;cursor:pointer;font-size:14px}.file-btn[_ngcontent-%COMP%]:hover, .action-btn[_ngcontent-%COMP%]:hover{background:#f0f0f0}.file-btn[_ngcontent-%COMP%]{display:inline-block}.action-btn.danger[_ngcontent-%COMP%]{color:#d32f2f}.action-btn.danger[_ngcontent-%COMP%]:hover{background:#ffebee;border-color:#d32f2f}.status[_ngcontent-%COMP%]{margin-left:auto;color:#666;font-size:12px}@media (max-width: 640px){.status[_ngcontent-%COMP%]{flex-basis:100%;margin-left:0}}.board-wrapper[_ngcontent-%COMP%]{position:relative;width:100%;height:100%;overflow:hidden;background:#fff}.svg-canvas[_ngcontent-%COMP%]{width:100%;height:100%;display:block;touch-action:none;background:#fff}.hit-area[_ngcontent-%COMP%]{fill:#fff}.whiteboard-container[data-mode=pan][_ngcontent-%COMP%]   .svg-canvas[_ngcontent-%COMP%]{cursor:grab}.whiteboard-container[data-mode=pan][_ngcontent-%COMP%]   .svg-canvas[_ngcontent-%COMP%]:active{cursor:grabbing}.whiteboard-container[data-mode=erase][_ngcontent-%COMP%]   .svg-canvas[_ngcontent-%COMP%], .whiteboard-container[data-mode=draw][_ngcontent-%COMP%]   .svg-canvas[_ngcontent-%COMP%]{cursor:crosshair}"],changeDetection:0})};export{Q as Whiteboard3Component};
